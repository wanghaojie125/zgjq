<!-- Data Tables -->
<link href="/content/css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">
<link href="/content/css/plugins/switchery/switchery.css" rel="stylesheet">
<link href="/content/css/plugins/iCheck/custom.css" rel="stylesheet">
<link href="/content/css/plugins/datapicker/bootstrap-datetimepicker.min.css" rel="stylesheet">
<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>
                        筛选条件
                    </h5>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <form class="form-horizontal">
                            <div class="form-group col-sm-3">
                                <label class="col-sm-5 control-label">上传编号：</label>
                                <div class="col-sm-7">
                                    <input id="search_id" name="search_id" placeholder="上传编号" type="text"
                                           class="form-control">
                                </div>
                            </div>
                            <div class="form-group col-sm-4">
                                <label class="col-sm-5 control-label">联系人：</label>
                                <div class="col-sm-7">
                                    <input id="search_name" placeholder="收货人姓名/手机号码" name="search_name" type="text"
                                           class="form-control">
                                </div>
                            </div>
                            <div class="form-group col-sm-5">
                                <label class="col-sm-3 control-label">申请时间：</label>
                                <div class="col-sm-9">
                                    <div class="input-group date form_datetime" data-date=""
                                         data-date-format="yyyy-mm-dd hh:mm:ss" data-link-field="start_at">
                                        <input class="form-control" id="read_search_date" size="16" type="text" value=""
                                               readonly>
                                        <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                                        <span class="input-group-addon"><span
                                                class="glyphicon glyphicon-th"></span></span>
                                    </div>
                                    <input type="hidden" id="search_date" name="search_date" value=""/><br/>
                                </div>
                            </div>
                            <div class="form-group col-sm-1">
                                <button class="btn btn-white btn-outline" type="button" id="btnSearch">查询</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="ibox-title">
                    <h5>
                        数据列表
                    </h5>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-7 m-b-xs">
                        </div>
                        <div class="col-sm-2 m-b-xs">
                            <select class="input-sm form-control input-s-sm inline" id="select_status">
                                <option value="" selected="selected">处理状态</option>
                                <option value="0">待处理</option>
                                <option value="1">处理成功</option>
                                <option value="2">处理失败</option>
                            </select>
                        </div>
                        <div class="col-sm-2 m-b-xs">
                            <select class="input-sm form-control input-s-sm inline" id="length">
                                <option value="10" selected="selected">显示条数</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                            </select>
                        </div>
                    </div>
                    <table class="table table-striped table-bordered table-hover dataTables-example" id="dataTable">
                        <thead>
                        <tr>
                            <th>
                                <div class="form-group">
                                    <div class="col-sm-10">
                                        <div class="checkbox checkbox-inline i-checks">
                                            <label>
                                                <input type="checkbox" data-oper="goods" value="0">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </th>
                            <th>上传编号</th>
                            <th>上传时间</th>
                            <th>用户账号</th>
                            <th>公司名称</th>
                            <th>联系人</th>
                            <th>申请状态</th>
                            <th>处理时间</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal inmodal fade" id="detailModeal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-full">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span
                            aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="order_title">图纸详情</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>图纸文件</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-striped table-bordered table-hover dataTables-example">
                                    <thead>
                                    <tr>
                                        <th>附件文件</th>
                                        <th>文件编号</th>
                                        <th>文件大小</th>
                                        <th>文件类型</th>
                                    </tr>
                                    </thead>
                                    <tbody id="fileInfo">
                                    <tr id="btnList">
                                        <td colspan="4">
                                            <button type="button" id="btnDownload"
                                                    class="btn btn-block btn-outline btn-primary">下载附件
                                            </button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="ibox float-e-margins" style="display: none;" data-status="0">
                            <div class="ibox-title">
                                <h5>服务单信息</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-striped table-bordered table-hover dataTables-example">
                                    <thead>
                                    <tr>
                                        <th>上传文件编号</th>
                                        <th>申请状态</th>
                                        <th>申请时间</th>
                                        <th>所属公司</th>
                                        <th>用户账号</th>
                                        <th>联系人</th>
                                        <th>联系电话</th>
                                        <th>客户留言</th>
                                    </tr>
                                    </thead>
                                    <tbody id="detailInfo">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="ibox float-e-margins" style="display: none;" data-status="0">
                            <div class="ibox-title">
                                <h5>处理意见</h5>
                            </div>
                            <div class="ibox-content">
                                <form class="form-horizontal m-t" id="statusForm">
                                    <input type="hidden" value="0" id="id" name="id">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label"><span
                                                style="color:red;">*</span>状态选择：</label>
                                        <div class="col-sm-8">
                                            <select class="form-control m-b" id="status" name="status">
                                                <option value="1">处理成功</option>
                                                <option value="2">处理失败</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label"><span
                                                style="color:red;">*</span>处理记录：</label>
                                        <div class="col-sm-8">
                                <textarea id="oper_log" name="oper_log" class="form-control"
                                          placeholder="请输入处理记录"></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-4 col-sm-offset-3">
                                            <button class="btn btn-primary" id="btnSaveStatus" type="button">提交</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="ibox float-e-margins" style="display: none;" data-status="1">
                            <div class="ibox-title">
                                <h5>服务单信息</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-striped table-bordered table-hover dataTables-example">
                                    <thead>
                                    <tr>
                                        <th>上传文件编号</th>
                                        <th>申请状态</th>
                                        <th>处理人员</th>
                                        <th>处理时间</th>
                                        <th>处理过程记录</th>
                                        <th>报价单编号</th>
                                        <th>最终确认加工文件</th>
                                    </tr>
                                    </thead>
                                    <tbody id="detailInfoSuccess">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="ibox float-e-margins" style="display: none;" data-status="2">
                            <div class="ibox-title">
                                <h5>服务单信息</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-striped table-bordered table-hover dataTables-example">
                                    <thead>
                                    <tr>
                                        <th>上传文件编号</th>
                                        <th>申请状态</th>
                                        <th>处理人员</th>
                                        <th>处理时间</th>
                                        <th>处理过程记录</th>
                                    </tr>
                                    </thead>
                                    <tbody id="detailInfoFail">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white"
                            data-dismiss="modal">关闭
                    </button>
                </div>
            </div>
        </div>
    </div>
    <form id="uploadFile" method="post" action="/upload_file" style="display: none;" enctype="multipart/form-data">
        <input type="file" id="file" name="file" accept="">
        <input type="hidden" id="key" name="key" value="dwg">
    </form>
    <script id="detailDWGTemplate" type="text/html">
        <tr class="tr_data">
            <td class="data"><img class="message-avatar" src="{{data.path}}" alt=""></td>
            <td class="data">{{data.file_no}}</td>
            <td class="data">{{data.size}}</td>
            <td class="data">{{data.type}}</td>
        </tr>
    </script>
    <script id="detailInfoTemplate" type="text/html">
        <tr class="tr_data">
            <td class="data">{{data.file_no}}</td>
            <td class="data">{{data.status_text}}</td>
            <td class="data">{{data.create_at}}</td>
            <td class="data">{{data.company}}</td>
            <td class="data">{{data.user_name}}</td>
            <td class="data">{{data.contact_name}}</td>
            <td class="data">{{data.phone}}</td>
            <td class="data">{{data.message}}</td>
        </tr>
    </script>
    <script id="detailInfoSuccessTemplate" type="text/html">
        <tr class="tr_data">
            <td class="data">{{data.file_no}}</td>
            <td class="data">{{data.status_text}}</td>
            <td class="data">{{data.oper_name}}</td>
            <td class="data">{{data.deal_at}}</td>
            <td class="data">{{data.oper_log}}</td>
            <td class="data">{{data.quotation_no}}</td>
            <td class="data"><img class="message-avatar" id="confirm_path" src="{{data.confirm_path}}" alt=""></td>
        </tr>
        <tr>
            <td colspan="4">
                <label class="btn btn-block btn-outline btn-primary" for="file">选择文件</label>
            </td>
            <td colspan="4">
                <button type="button" id="btnUpLoad"
                        class="btn btn-block btn-outline btn-primary">上传文件
                </button>
            </td>
        </tr>
    </script>
    <script id="detailInfoFailTemplate" type="text/html">
        <tr class="tr_data">
            <td class="data">{{data.file_no}}</td>
            <td class="data">{{data.status_text}}</td>
            <td class="data">{{data.oper_name}}</td>
            <td class="data">{{data.deal_at}}</td>
            <td class="data">{{data.oper_log}}</td>
        </tr>
    </script>
    <script src="/content/js/plugins/dataTables/dataTables.bootstrap.js"></script>

    <!-- jQuery Validation plugin javascript-->
    <script src="/content/js/plugins/validate/jquery.validate.min.js"></script>
    <script src="/content/js/plugins/validate/messages_zh.min.js"></script>
    <!-- jQuery Form plugin javascript-->
    <script src="/content/js/jquery.form.js"></script>
    <!-- Switchery -->
    <script src="/content/js/plugins/switchery/switchery.js"></script>

    <!-- iCheck -->
    <script src="/content/js/plugins/iCheck/icheck.min.js"></script>
    <!-- Data picker -->
    <script src="/content/js/plugins/datapicker/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript">
        (function ($) {
            $.validator.setDefaults({
                highlight: function (element) {
                    $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
                },
                success: function (element) {
                    element.closest('.form-group').removeClass('has-error').addClass('has-success');
                },
                errorElement: "span",
                errorClass: "help-block m-b-none",
                validClass: "help-block m-b-none"
            });
            $.order = {
                init: function () {
                    var _self = this;
                    this.getData();
                    $('.form_datetime').datetimepicker({
                        weekStart: 1,
                        todayBtn: 1,
                        autoclose: 1,
                        todayHighlight: 1,
                        startView: 2,
                        forceParse: 0,
                        showMeridian: 1
                    });
                },
                table: "",
                getData: function () {
                    var _self = this;
                    var pageLength = $('#length').val();
                    this.table = $('#dataTable').DataTable({
                        serverSide: true,
                        searching: false,
                        ordering: false,
                        pageLength: pageLength,
                        pagingType: "full_numbers",
                        stateSave: true,
                        bLengthChange: false,
                        ajax: {
                            url: "/dwg/list_data",
                            dataSrc: 'data',
                            data: function (d) {
                                var param = {};
                                param.draw = d.draw;
                                param.start = d.start;
                                param.length = d.length;
                                param.search_id = $('#search_id').val();
                                param.search_name = $('#search_name').val();
                                param.search_date = $('#search_date').val();
                                param.select_status=$('#select_status').val();
                                return param;
                            }
                        },
                        columns: [
                            {
                                data: "null",
                                render: function (data, type, row, meta) {
                                    var html = ' <div class="form-group"> <div class="col-sm-10"> <div class="checkbox checkbox-inline i-checks"> <label> <input type="checkbox" data-oper="goods" value="0"> </label> </div> </div> </div>';
                                    return html;
                                }
                            },
                            {data: "file_no"},
                            {data: "create_at",},
                            {data: "user_name"},
                            {data: "company",},
                            {data: "contact_name"},
                            {
                                data: "status", render: function (data, type, row, meta) {
                                    var text="";
                                    switch (data) {
                                        case 0:
                                            text = "待处理";
                                            break;
                                        case 1:
                                            text = "处理成功";
                                            break;
                                        case 2:
                                            text = "处理失败";
                                            break;
                                    }
                                    return text;
                                }
                            },
                            {data: "deal_at"},
                            {
                                data: null,
                                render: function (data, type, row, meta) {
                                    var html = [];
                                    html.push('<a data-id="' + row.id + '" data-toggle="modal" data-target="#detailModeal" data-oper="detail" href="#">查看详情</a>&nbsp;&nbsp;&nbsp;');
                                    return html.join('');
                                }
                            }
                        ],
                        fnDrawCallback: function () {
                            $('a[data-oper="detail"]').off().on('click', function () {
                                var id = $(this).data('id');
                                _self.detail(id);
                            });
                            $('#length').on('change', function () {
                                var index = $(this).val();
                                if (_self.table) {
                                    _self.table.page.len(index);
                                    _self.table.ajax.reload();
                                }
                            });
                            $('#select_status').on('change', function () {
                                var index = $("#length").val();
                                if (_self.table) {
                                    _self.table.page.len(index);
                                    _self.table.ajax.reload();
                                }
                            });
                            $('#btnSearch').off().on('click', function () {
                                var index = $("#length").val();
                                if (_self.table) {
                                    _self.table.page.len(index);
                                    _self.table.ajax.reload();
                                }
                            });
                        }
                    });
                },
                detail: function (id) {
                    var _self = this;
                    $.getJSON("/dwg/get_dwg", {id: id}, function (res) {
                        if (res.success) {
                            var text = "";
                            switch (res.data.status) {
                                case 0:
                                    text = "待处理";
                                    break;
                                case 1:
                                    text = "处理成功";
                                    break;
                                case 2:
                                    text = "处理失败";
                                    break;
                            }
                            res.data.status_text = text;
                            var data = {
                                data: res.data
                            };
                            $('#id').val(res.data.id);
                            var html = template('detailDWGTemplate', data);
                            $('#fileInfo  tr.tr_data').remove();
                            $('#btnList').before(html);
                            $('#btnDownload').off().on('click', function () {
                                window.open(res.data.path);
                            });
                            var htmlInfo = template('detailInfoTemplate', data);
                            $('#detailInfo').html(htmlInfo);

                            var htmlSucces = template('detailInfoSuccessTemplate', data);
                            $('#detailInfoSuccess').html(htmlSucces);

                            var htmlFail = template('detailInfoFailTemplate', data);
                            $('#detailInfoFail').html(htmlFail);
                            $('div[data-status="' + res.data.status + '"]').show();
                            $('#btnSaveStatus').off().on('click', function () {
                                _self.save_status();
                            });
                            $.file_upload({
                                file:"#file",
                                img: "#confirm_path",
                                size:50,
                                upload:"#btnUpLoad",
                                form:"#uploadFile",
                                success:function (res) {
                                    if(res.success)
                                    {
                                        toastr.success("文件上传", res.msg);
                                        var data={
                                            id:$('#id').val(),
                                            confirm_path:res.data.url,
                                        }
                                        $.request('/dwg/save_confirm_path', data, function (res) {
                                            if (res.success) {
                                                if (_self.table) {
                                                    _self.table.ajax.reload();
                                                }
                                                toastr.success("状态", res.msg);
                                            }
                                            else {
                                                toastr.error("状态", res.msg);
                                            }
                                            $('#detailModeal').modal('hide');
                                        });
                                        // $('#cover').val(data.url);
                                        // $('#path').val(data.path);
                                    }else {
                                        toastr.error("文件上传", res.msg);
                                    }
                                }
                            });
                        }
                    });
                },
                save_status: function () {
                    var _self = this;
                    var f = $('#statusForm').validate({
                        ignore: [],
                        rules: {
                            status: {
                                required: true,
                                min: 1
                            },
                            oper_log: "required",
                        },
                        messages: {
                            status: {
                                required: "请选择处理状态",
                                min: "请选择处理状态"
                            },
                            oper_log: "请输入处理日志",
                        }
                    });
                    if (f.form()) {
                        var data = $('#statusForm').formToObj();
                        $.request('/dwg/save_status', data, function (res) {
                            if (res.success) {
                                if (_self.table) {
                                    _self.table.ajax.reload();
                                }
                                toastr.success("状态", res.msg);
                            }
                            else {
                                toastr.error("状态", res.msg);
                            }
                            $('#statusForm').resetForm();
                            $('#detailModeal').modal('hide');
                        });
                    }
                }
            }
            $(function () {
                    $.order.init();
                }
            )
            ;
        })(jQuery)

    </script>
</div>